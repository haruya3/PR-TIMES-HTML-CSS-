# Webアプリケーションのパフォーマンス
Webアプリケーションで意識すべきは、「レイテンシー」と「シングルスレッド」である。
以下にパフォーマンスを上げるにはどうすれば良いのか、クライアントがリクエストしてからレスポンスが返ってくるまでの各項目について見ていく。
## ナビゲーション
ユーザの操作のこと。検索バーに入力したり記事の内容を書いたりなど。

## DNS lookup
名前解決のこと。物理的にネームサーバやコンテンツキャッシュサーバ、wifiのプロバイダーなどの距離が離れいていると、パフォーマンス低下の原因につながる。

## TCPハンドシェイク
ブラウザとサーバのコネクションを確立するために必要な作業。3回以上のやり取りが必要になる。
サーバ3台の場合。これって、ロードバランサで振り分けている場合にコネクションを確立したサーバと違うサーバに振り分けられることあるのか。
もしあるなら、パフォーマンス悪そう(誤差なのかな？)。


## TCPネゴシエーション
ブラウザとサーバ間でHTTPSを確立するために必要な作業。3回のやり取りが必要。

ここまでで、結構なサーバとのやり取りがある。

## レスポンス
レスポンスされるリソースは輻輳制御(最初に14KBからはじめACKフラグ返ってきたら、次に28Kと増やしていく)されながら、少しずつレスポンスされる。
このレスポンスされたかたまりを画面に表示するために解析することを解釈処理という。
また、

### 解釈処理
DOMとCSSOMに変換するステップです。
#### DOMツリー構築
主にトークン化してツリーの構築をする。
トークン化はHTMLの開始タグや終了タグ、属性や値を解釈し解釈したものをツリーを構築する。また、ツリーの構築時間はDOMツリーをネストしすぎると遅くなるので注意。


#### 先読みスキャナー
ブラウザでDOMツリーを構築する時、つまりHTMLやCSSを解釈しているときはメインスレッドを占有する。そこで、先読みでscript, javascriptを読み込みダウンロードするものはバックグラウンドで実行してくれている。よって、DOMツリーを構築して画面に表示する時にはダウンロードされ終わっている。
しかし、cssの先読みはjavascriptの実行をブロックすることに注意(jsがcssに影響を与える可能性があるから)。

#### CSSOMツリーの構築
DOMツリーと同様のツリー構造だが、それぞれは独立している。CSSのルールをHTMLに対して行うこと(DOMツリーの構築)同様にブラウザーが理解できるスタイルのマップに変換する。
**CSSOMツリーの構築にかかる時間は1回のDNS lookupの時間より短いらしい**。つまり、ここの処理についてはさほど気にしなくて良いのかも。

#### AOM(アクセシビリティツリー)の構築
補助機器むけDOMであり、ブラウザがそれを理解できるようにAOMを構築する時間もある。

### レンダリング
DOMツリーとCSSOMの構築が終わると画面に描画する処理が始まる、、

#### スタイル
DOMとCSSOMをレンダーツリーに取り込む。目にみえる全てのノードがCSSOMルールが適応される。そして、目にみえるコンテンツ(ノード)にそれぞれ対応するスタイルを適応する。

#### レイアウト
ノードの幅、高さ、位置を決める処理。この最初に決められる処理がレイアウトと呼ばれる。
そして、レイアウトに続いてノードのサイズと位置を再計算することを再フローと呼ぶ。
再フローが行われる例として、画像の取得の前にレイアウトが完了して、画像を取得が完了した時点で位置とサイズの再計算が行われるなど。

#### 描画
ここでやっと全てを描画し始める。
> ラウザーはレイアウト段階で計算されたそれぞれのボックスを画面上の実際のピクセルに変換します



#### 合成
> ドキュメントのセクションが異なるレイヤーに描画されていて、それらが重なり合っているとき、コンテンツを画面上に正しい順番で描画するために合成が必要になります。

再フローが行われると、再描画と再合成が行われる。先ほどの例から画像を取得する時にサイズを指定していないから再フローが行われる。よって、画像の取得にサイズを指定することで再フローを防ぎ再描画と再合成を防ぎ、パフォーマンスの低下を防ぐことができる。
